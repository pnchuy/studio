
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Books, Authors, Genres, Series: Allow public read access
    match /{collection}/{docId} where collection in ['books', 'authors', 'genres', 'series'] {
      allow read: if true;
      allow write: if false; // Deny all writes for now
    }

    // Users:
    match /users/{userId} {
      // Allow anyone to read user data (needed for username login check)
      allow read: if true;

      // Allow a user to create their own profile
      // The username must not already exist
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && !exists(/databases/$(database)/documents/users_by_username/$(request.resource.data.username));
      
      // Allow a user to update their own profile
      allow update: if request.auth != null && request.auth.uid == userId;

      // Prevent users from being deleted for now
      allow delete: if false;
    }

    // Helper collection to enforce username uniqueness
    match /users_by_username/{username} {
      allow read: if true;
      // Allow creation only if the user is creating their own entry
      allow create: if request.auth.uid == request.resource.data.userId;
      allow write: if false;
    }
  }
}
