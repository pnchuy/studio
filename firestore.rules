
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow read access to public collections for all users (logged in or not)
    match /books/{bookId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'MANAGER'];
    }

    match /authors/{authorId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'MANAGER'];
    }

    match /genres/{genreId} {
      allow read: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['ADMIN', 'MANAGER'];
    }

    // Users collection rules
    match /users/{userId} {
      // Anyone can create their own user document (on signup)
      allow create: if request.auth.uid == userId;

      // Only authenticated users can read user data (e.g., for comments or user lists)
      allow read: if request.auth != null;

      // Update rules:
      // 1. Users can update their own data.
      // 2. Admins can update anyone's data.
      // 3. Managers can update members, but not promote them to Admin.
      allow update: if request.auth.uid == userId ||
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN' ||
                       (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'MANAGER' && resource.data.role == 'MEMBER' && request.resource.data.role != 'ADMIN');

      // Delete rules:
      // 1. Admins can delete any user except themselves.
      // 2. Managers can delete members.
      allow delete: if request.auth.uid != userId &&
                       (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN' ||
                        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'MANAGER' && resource.data.role == 'MEMBER'));
    }
  }
}
